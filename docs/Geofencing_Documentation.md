# ๐ ูุธุงู ุงููุทุงู ุงูุฌุบุฑุงูู ุงูุชุฏุฑูุฌู (Progressive Geofencing)
## ุฏููู ูุทูุฑ ุชุทุจููุงุช ุงูููุจุงูู

---

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู Quick ูุณุชุฎุฏู ูุทุงู ุฌุบุฑุงูู ุชุฏุฑูุฌู ูุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุงูุทูุจุงุช ููุณุงุฆูููุ ููุง ูุถูู:
- ุชูุฒูุน ุนุงุฏู ููุทูุจุงุช ุนูู ุงูุณุงุฆููู ุงููุฑูุจูู
- ุชูููู ููุช ุงูุชุธุงุฑ ุงูุนููู
- ุชุญุณูู ููุงุกุฉ ุงูุชูุตูู

---

## ๐ฏ ุขููุฉ ุงูุนูู

### ุงูุชูุณุน ุงูุชุฏุฑูุฌู ูููุทุงู

```
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ               ุชูุณุน ุงููุทุงู ุงูุฌุบุฑุงูู ุนุจุฑ ุงูุฒูู                    โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

                              5 ูู (8-10 ุฏูุงุฆู)
                         โโโโโโโโโโโโโโโโโโโโโโโ
                         โ     4 ูู (6-8)      โ
                         โ  โโโโโโโโโโโโโโโโโ  โ
                         โ  โ   3 ูู (4-6)  โ  โ
                         โ  โ  โโโโโโโโโโโ  โ  โ
                         โ  โ  โ 2 ูู    โ  โ  โ
                         โ  โ  โ โโโโโโโ โ  โ  โ
                         โ  โ  โ โ1 ูู โ โ  โ  โ
                         โ  โ  โ โ  ๐ โ โ  โ  โ  โ ูุฑูุฒ ุงูุทูุจ
                         โ  โ  โ โ     โ โ  โ  โ
                         โ  โ  โ โโโโโโโ โ  โ  โ
                         โ  โ  โโโโโโโโโโโ  โ  โ
                         โ  โโโโโโโโโโโโโโโโโ  โ
                         โโโโโโโโโโโโโโโโโโโโโโโ
```

### ุฌุฏูู ุงูุชูุณุน ุงูุฒููู

| ุงููุชุฑุฉ ุงูุฒูููุฉ | ูุตู ุงููุทุฑ | ุงููุตู |
|---------------|----------|-------|
| 0 - 2 ุฏูููุฉ | 1 ูู | ุงููุทุงู ุงูุฃููู - ุงูุณุงุฆููู ุงููุฑูุจูู ุฌุฏุงู |
| 2 - 4 ุฏูุงุฆู | 2 ูู | ุงูุชูุณุน ุงูุฃูู |
| 4 - 6 ุฏูุงุฆู | 3 ูู | ุงูุชูุณุน ุงูุซุงูู |
| 6 - 8 ุฏูุงุฆู | 4 ูู | ุงูุชูุณุน ุงูุซุงูุซ |
| 8 - 10 ุฏูุงุฆู | 5 ูู | ุงูุญุฏ ุงูุฃูุตู |

> โ๏ธ **ููุงุญุธุฉ:** ุฃูู ุณุงุฆู ููุจู ุงูุทูุจ โ ูุชู ุฅุบูุงู ุงูุทูุจูุฉ ููุฑุงู

---

## ๐ ููุทุฉ ุงููุฑูุฒ ุงูุฌุบุฑุงูู

### ููุทูุจ ุงูุนุงุฏู (Order)
ุงููุทุงู ููุญุณุจ ูู **ูุฑูุฒ ุซูู ุงููุชุงุฌุฑ** ูู ุงูุทูุจ:

```
    ุงููุชุฌุฑ A (35.1298, 36.7489)     ุงููุชุฌุฑ B (35.1318, 36.7514)
              โ                              โ
               \                            /
                \                          /
                 \                        /
                  โ  ูุฑูุฒ ุงูุซูู (ุงููุชูุณุท)
                 /                        \
                /                          \
               /                            \
    ุงููุชุฌุฑ C (35.1280, 36.7500)
              โ
```

### ููุทูุจ ุงูุฎุงุต (CustomOrder)
ุงููุทุงู ููุญุณุจ ูู **ูุฑูุฒ ุซูู ููุงุท ุงูุงุณุชูุงู + ูููุน ุงูุชูุตูู**

---

## ๐ ุดุฑูุท ุงูุณุงุฆู ุงููุคูู

ุงูุณุงุฆู ูุฌุจ ุฃู ูุณุชููู **ุฌููุน** ุงูุดุฑูุท ุงูุชุงููุฉ ููุธูุฑ ูู ุงูุทูุจ:

### 1. ุงูุญุงูุฉ ุงููุดุทุฉ
```json
{
    "is_active": true,      // ุงูุญุณุงุจ ูุดุท (ุบูุฑ ููููู)
    "is_online": true       // ูุชุตู ุญุงููุงู
}
```

### 2. ุงููุดุงุท ุงูุฃุฎูุฑ
```
ุขุฎุฑ ูุดุงุท (last_activity_at) โค 5 ุฏูุงุฆู
```

### 3. ุงููููุน ุงูุฌุบุฑุงูู
- ุฅุญุฏุงุซูุงุช ุงููููุน ุงูุญุงูู ูุชููุฑุฉ
- ุฏุงุฎู ูุตู ุงููุทุฑ ุงูุญุงูู ููุทูุจ

### 4. ุฑุตูุฏ ุงููุญูุธุฉ
```
ุฑุตูุฏ ุงููุญูุธุฉ โฅ ูุณุจุฉ ุงูุฑุจุญ ุงููุทููุจุฉ ููุฑุญูุฉ
```

### 5. ุงูุทูุจุงุช ุงููุดุทุฉ

| ููุน ุงูุทูุจ | ุงูุดุฑุท |
|-----------|------|
| **ููุฑู** | ูุง ููุฌุฏ ุทูุจ ููุฑู ูุดุท (0 ุทูุจ shipping) |
| **ูุฌุฏูู** | ุฃูู ูู 3 ุทูุจุงุช ูุฌุฏููุฉ ูุดุทุฉ |

---

## ๐ APIs ููุณุงุฆู

### ุชุญุฏูุซ ุงููููุน

> โ๏ธ **ูุทููุจ:** ุฅุฑุณุงู ุงููููุน ูู 30 ุซุงููุฉ ุชูุฑูุจุงู

```http
POST /api/driver/location
Authorization: Bearer {driver_token}
Content-Type: application/json

{
    "lat": 35.1318,
    "lng": 36.7514
}
```

**Response:**
```json
{
    "success": true,
    "message": "ุชู ุชุญุฏูุซ ุงููููุน ุจูุฌุงุญ",
    "data": {
        "lat": 35.1318,
        "lng": 36.7514,
        "updated_at": "2026-01-21T10:30:00+00:00"
    }
}
```

### ุชุจุฏูู ุญุงูุฉ ุงูุงุชุตุงู

```http
POST /api/driver/toggle-online
Authorization: Bearer {driver_token}
```

**Response:**
```json
{
    "success": true,
    "message": "ุชู ุชูุนูู ุงูุงุชุตุงู",
    "data": {
        "is_online": true,
        "message": "ุฃูุช ุงูุขู ูุชุตู"
    }
}
```

### Heartbeat (ุชุณุฌูู ุงููุดุงุท)

> โ๏ธ **ูุทููุจ:** ุฅุฑุณุงู ูู ุฏูููุฉ ููุญูุงุธ ุนูู ุญุงูุฉ ุงููุดุงุท

```http
POST /api/driver/heartbeat
Authorization: Bearer {driver_token}
```

**Response:**
```json
{
    "success": true,
    "data": {
        "is_active": true,
        "is_online": true,
        "last_activity_at": "2026-01-21T10:30:00+00:00"
    }
}
```

---

## ๐ฆ ูุจูู ุงูุทูุจ ูุน ุชุฑุชูุจ ุงูุชูููุฐ

ุนูุฏ ูุจูู ุงูุณุงุฆู ููุทูุจุ ูุชู ุฅุฑุฌุงุน ุชุฑุชูุจ ุฒูุงุฑุฉ ุงููุชุงุฌุฑ ุชููุงุฆูุงู:

```http
POST /api/driver/orders/{id}/accept
Authorization: Bearer {driver_token}
```

**Response:**
```json
{
    "success": true,
    "message": "ุชู ูุจูู ุงูุทูุจ ุจูุฌุงุญ",
    "data": {
        "order": {
            "id": 5,
            "orderNumber": "ORD-000005",
            "status": "shipping",
            "...": "..."
        },
        "execution_route": {
            "stores_order": [
                {
                    "id": 3,
                    "name": "ูุชุฌุฑ ุงูุฅููุชุฑูููุงุช",
                    "lat": 35.1298,
                    "lng": 36.7489,
                    "distance_from_start": 0.5
                },
                {
                    "id": 7,
                    "name": "ูุชุฌุฑ ุงูููุงุจุณ",
                    "lat": 35.1318,
                    "lng": 36.7514,
                    "distance_from_start": 1.2
                }
            ],
            "distance_to_delivery": 2.3,
            "total_estimated_distance": 4.0
        }
    }
}
```

### ุชุฑุชูุจ ุงูุชูููุฐ

1. **ุงููุชุฌุฑ ุงูุฃูู** โ ุงูุฃูุฑุจ ููููุน ุงูุณุงุฆู ุงูุญุงูู
2. **ุงููุชุฌุฑ ุงูุซุงูู** โ ุงูุชุงูู ูู ุงูุชุฑุชูุจ
3. ... (ุญุณุจ ุงููุณุงูุฉ)
4. **ูููุน ุงูุชูุตูู** โ ุงููุฌูุฉ ุงูููุงุฆูุฉ

> โ๏ธ **ููุงุญุธุฉ:** ุงูุณุงุฆู **ูุง ูููู ุตูุงุญูุฉ ุชุบููุฑ ุงูุชุฑุชูุจ**

---

## ๐ซ ูููุฏ ุงููุณุงูุฉ ุจูู ุงููุชุงุฌุฑ

### ุงููุงุนุฏุฉ
```
ุงููุณุงูุฉ ุจูู ุฃู ูุชุฌุฑูู ูู ุงูุทูุจ ุงููุงุญุฏ โค 3 ูู
```

### ุณููู ุงููุธุงู

ุนูุฏ ูุญุงููุฉ ุฅุชูุงู ุทูุจ ุจูุชุงุฌุฑ ูุชุจุงุนุฏุฉ:

```http
POST /api/checkout
```

**Response (400 Bad Request):**
```json
{
    "success": false,
    "message": "ูุง ูููู ุฅุชูุงู ุงูุทูุจ: ุงููุณุงูุฉ ุจูู \"ูุชุฌุฑ A\" ู \"ูุชุฌุฑ B\" ุชุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ (3 ูู). ุงููุณุงูุฉ ุงููุนููุฉ: 4.5 ูู",
    "errors": {
        "error_type": "stores_distance_exceeded",
        "max_distance": 4.5,
        "max_allowed": 3,
        "stores_pair": {
            "store1": {"id": 1, "name": "ูุชุฌุฑ A"},
            "store2": {"id": 2, "name": "ูุชุฌุฑ B"}
        }
    }
}
```

### ุงูุญู ูููุณุชุฎุฏู
- ุฅุฒุงูุฉ ุฃุญุฏ ุงููุชุงุฌุฑ ุงูุจุนูุฏุฉ ูู ุงูุณูุฉ
- ุฅูุดุงุก ุทูุจูู ูููุตููู

---

## ๐ฑ ูุชุทูุจุงุช ุชุทุจูู ุงูุณุงุฆู

### ุชุญุฏูุซ ุงููููุน ุงููุณุชูุฑ
```javascript
// ูู 30 ุซุงููุฉ
setInterval(() => {
    navigator.geolocation.getCurrentPosition(position => {
        api.post('/driver/location', {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        });
    });
}, 30000);
```

### Heartbeat
```javascript
// ูู 60 ุซุงููุฉ
setInterval(() => {
    api.post('/driver/heartbeat');
}, 60000);
```

### ุฅุฏุงุฑุฉ ุญุงูุฉ ุงูุงุชุตุงู
```javascript
// ุนูุฏ ูุชุญ ุงูุชุทุจูู
api.post('/driver/toggle-online');

// ุนูุฏ ุฅุบูุงู ุงูุชุทุจูู ุฃู ุงูุฎุฑูุฌ
api.post('/driver/toggle-online'); // ูุฅููุงู ุงูุงุชุตุงู
```

---

## ๐ ููุฎุต ุงูู APIs

| ุงูุทุฑููุฉ | ุงููุณุงุฑ | ุงููุตู | ุงูุชูุฑุงุฑ |
|---------|--------|-------|---------|
| `POST` | `/api/driver/location` | ุชุญุฏูุซ ุงููููุน | ูู 30 ุซุงููุฉ |
| `POST` | `/api/driver/toggle-online` | ุชุจุฏูู ุงูุงุชุตุงู | ุนูุฏ ุงููุชุญ/ุงูุฅุบูุงู |
| `POST` | `/api/driver/heartbeat` | ุชุณุฌูู ุงููุดุงุท | ูู 60 ุซุงููุฉ |
| `POST` | `/api/driver/orders/{id}/accept` | ูุจูู + ุชุฑุชูุจ ุงูุชูููุฐ | ุนูุฏ ุงููุจูู |

---

## ๐ง ุงูุซูุงุจุช ุงููุงุจูุฉ ููุชุนุฏูู

```php
// GeofencingService.php

// ุงููุทุงู ุงูุฌุบุฑุงูู ุงูุชุฏุฑูุฌู
const PROGRESSIVE_RADIUS_CONFIG = [
    2  => 1,   // 0-2 ุฏูููุฉ: 1 ูู
    4  => 2,   // 2-4 ุฏูุงุฆู: 2 ูู
    6  => 3,   // 4-6 ุฏูุงุฆู: 3 ูู
    8  => 4,   // 6-8 ุฏูุงุฆู: 4 ูู
    10 => 5,   // 8-10 ุฏูุงุฆู: 5 ูู
];

// ุงูุญุฏ ุงูุฃูุตู ูููุณุงูุฉ ุจูู ุงููุชุงุฌุฑ
const MAX_DISTANCE_BETWEEN_STORES_KM = 3;

// ูุฏุฉ ุงุนุชุจุงุฑ ุงูุณุงุฆู ูุดุทุงู
const DRIVER_ACTIVITY_TIMEOUT_MINUTES = 5;
```

---

## โ๏ธ ููุงุญุธุงุช ูุงูุฉ

1. **ุงูุณุงุฆู ุฎุงุฑุฌ ุงูุชุทุจูู**: ุฅุฐุง ูู ููุณุฌู ูุดุงุท ุฎูุงู 5 ุฏูุงุฆูุ ูู ูุธูุฑ ูู ุฃู ุทูุจ
2. **ุงูุชูุงุก ุตูุงุญูุฉ ุงูุทูุจ**: ุฅุฐุง ูู ููุจู ุฃู ุณุงุฆู ุฎูุงู 10 ุฏูุงุฆูุ ูููู ูููุณุชุฎุฏู ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู
3. **Race Condition**: ุฃูู ุณุงุฆู ูุถุบุท "ูุจูู" ูุญุตู ุนูู ุงูุทูุจ (atomic update)
4. **ุชุฑุชูุจ ุงููุชุงุฌุฑ**: ุงููุธุงู ูุญุฏุฏู ุชููุงุฆูุงู ููุง ูููู ููุณุงุฆู ุชุบููุฑู
